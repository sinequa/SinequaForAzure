{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "prefix": {
            "type": "string",
            "defaultValue": "sq"
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },
        "adminUsername": {
            "type": "string"
        },
        "adminPassword": {
            "type": "secureString"
        },
        "vmSize": {
            "type": "string"
        },
        "vmIndexerSize": {
            "type": "string"
        },
        "primaryNodeCount": {
            "type": "int"
        },
        "vmIndexerScaleSetSize": {
            "type": "int",
            "defaultValue": 1
        },       
        "certificateBase64": {
            "type": "securestring"
        },
        "certificatePassword": {
            "type": "secureString"
        },
        "license": {
            "type": "string"
        },
        "imageReferenceId": {
            "type": "string",
            "defaultValue": "none"
        },
        "virtualNetwork": {
            "type": "object"
        },
        "_artifactsLocation": {
          "type": "string",
          "metadata": {
              "description": "The base URI where artifacts required by this template are located including a trailing '/'"
          },
          "defaultValue": "[deployment().properties.templateLink.uri]"
        },
        "_artifactsLocationSasToken": {
          "type": "securestring",
          "metadata": {
              "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated. Use the defaultValue if the staging location is not secured."
          },
          "defaultValue": ""
        }        
    },
    "variables": {
        "kv_name"                   : "[substring(concat('kv-', parameters('prefix'), '-', replace(guid(resourceGroup().id), '-', '')), 0, 24)]",
        "st_name"                   : "[substring(concat('st',replace(guid(resourceGroup().id), '-', '')), 0, 24)]",
        "container_name"            : "sinequa",
        "node1_name"                : "node1",
        "node1_pn_id"               : "1",
        "node2_name"                : "node2",
        "node2_pn_id"               : "2",
        "node3_name"                : "node3",
        "node3_pn_id"               : "3",
        "vm_node1_name"             : "[concat('vm-',variables('node1_name'))]",
        "vm_node2_name"             : "[concat('vm-',variables('node2_name'))]",
        "vm_node3_name"             : "[concat('vm-',variables('node3_name'))]",
        "primary_nodes"             : "[concat('1=srpc://', variables('node1_name'),':10301')]",
        "primary_nodes3"            : "[concat('1=srpc://', variables('node1_name'),':10301',';2=srpc://', variables('node2_name'),':10301',';3=srpc://', variables('node3_name'),':10301')]",
        "indexer_name"              : "indexer",
        "vmss_indexer_name"         : "[concat('vm-',variables('indexer_name'))]",
        "queue_cluster"             : "[concat('QueueCluster1(''',variables('node1_name'),''')')]",
        "nsg_app_name"              : "[concat('nsg-',parameters('prefix'),'-app')]",
        "nsg_front_name"            : "[concat('nsg-',parameters('prefix'),'-front')]",
        "availability_set_name"     : "[concat('as-', parameters('prefix'))]",
        "application_gateway_name"  : "[concat('ag-',parameters('prefix'))]",
        "vnet_id"                   : "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetwork').name)]",
        "subnet_id2"                : "[concat(variables('vnet_id'), '/subnets/', parameters('virtualNetwork').subnets.subnet2.name)]",
        "subnet_id1"                : "[concat(variables('vnet_id'), '/subnets/', parameters('virtualNetwork').subnets.subnet1.name)]",
        "data_storage_url"          : "[concat('https://',variables('st_name'),'.blob','.core','.windows','.net/',variables('container_name'))]",
        "imageReferenceId"          : "[if(equals(parameters('imageReferenceId'),'none'),'',parameters('imageReferenceId'))]",
        "backend_address_pool_id"   : "[concat(resourceId('Microsoft.Network/applicationGateways', variables('application_gateway_name')),'/backendAddressPools/sinequaBackendPool')]",
        "frontend_template_uri"     : "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/frontend.json', parameters('_artifactsLocationSasToken')))]",
        "network_template_uri"      : "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/network.json', parameters('_artifactsLocationSasToken')))]",
        "services_template_uri"     : "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/services.json', parameters('_artifactsLocationSasToken')))]",
        "vm_template_uri"           : "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/vm.json', parameters('_artifactsLocationSasToken')))]",
        "vmss_template_uri"         : "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/vmss.json', parameters('_artifactsLocationSasToken')))]"

    },    
    "resources": [   
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "network",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('network_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "vnet" : {"value":"[parameters('virtualNetwork')]"},
                     "nsg_app_name" : {"value":"[variables('nsg_app_name')]"},
                     "nsg_front_name" : {"value":"[variables('nsg_front_name')]"}
                }                
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "frontend",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('frontend_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "availability_set_name" : {"value":"[variables('availability_set_name')]"},
                     "application_gateway_name" : {"value":"[variables('application_gateway_name')]"},
                     "subnet_id" : {"value":"[variables('subnet_id2')]"},
                     "certificate_data" : {"value":"[parameters('certificateBase64')]"},
                     "certificate_password" : {"value":"[parameters('certificatePassword')]"}
                }                
            },
             "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'network')]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "services",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('services_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "kv_name" : {"value":"[variables('kv_name')]"},
                     "st_name" : {"value":"[variables('st_name')]"},
                     "admin_username" : {"value":"[parameters('adminUsername')]"},
                     "admin_password" : {"value":"[parameters('adminPassword')]"},
                     "license" : {"value":"[parameters('license')]"},
                     "container_name" : {"value":"[variables('container_name')]"},
                     "blob_sinequa_primary_nodes" : {"value":"[if(equals(parameters('primaryNodeCount'),3),variables('primary_nodes3'),variables('primary_nodes'))]"},
                     "blob_sinequa_beta" : {"value":true},
                     "blob_sinequa_keyvault" : {"value":"[variables('kv_name')]"},
                     "blob_sinequa_queuecluster" : {"value":"[variables('queue_cluster')]"}
                }                
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "primarynode1",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vm_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "vm_name" : {"value":"[variables('vm_node1_name')]"},
                     "vm_size" : {"value":"[parameters('vmSize')]"},
                     "computer_name" : {"value":"[variables('node1_name')]"},
                     "admin_username" : {"value":"[parameters('adminUsername')]"},
                     "admin_password" : {"value":"[parameters('adminPassword')]"},
                     "subnet_id" : {"value":"[variables('subnet_id1')]"},
                     "image_id": {"value":"[variables('imageReferenceId')]"},
                     "availability_set_id" : {"value":"[resourceId('Microsoft.Compute/availabilitySets', variables('availability_set_name'))]"},
                     "network_security_group_id" : {"value":"[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_app_name'))]"},
                     "pip" : {"value":true},
                     "backend_address_pool_id" : {"value":"[variables('backend_address_pool_id')]"},
                     "tags" : {"value":
                                        {
                                            "sinequa-grid"                        : "[parameters('prefix')]",
                                            "sinequa-auto-disk"                   : "auto",
                                            "sinequa-path"                        : "F:\\sinequa",
                                            "sinequa-data-storage-url"            : "[variables('data_storage_url')]",
                                            "sinequa-primary-node-id"             : "[variables('node1_pn_id')]",
                                            "sinequa-node"                        : "[variables('node1_name')]",
                                            "sinequa-webapp"                      : "webapp1",
                                            "sinequa-engine"                      : "engine1"
                                        }}
                }                
            },
              "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'network')]",
                 "[resourceId('Microsoft.Resources/deployments', 'frontend')]",
                 "[resourceId('Microsoft.Resources/deployments', 'services')]"
            ]
        },
        {
            "condition": "[equals(parameters('primaryNodeCount'),3)]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "primarynode2",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vm_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "vm_name" : {"value":"[variables('vm_node2_name')]"},
                     "vm_size" : {"value":"[parameters('vmSize')]"},
                     "computer_name" : {"value":"[variables('node2_name')]"},
                     "admin_username" : {"value":"[parameters('adminUsername')]"},
                     "admin_password" : {"value":"[parameters('adminPassword')]"},
                     "subnet_id" : {"value":"[variables('subnet_id1')]"},
                     "image_id": {"value":"[variables('imageReferenceId')]"},
                     "availability_set_id" : {"value":"[resourceId('Microsoft.Compute/availabilitySets', variables('availability_set_name'))]"},
                     "network_security_group_id" : {"value":"[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_app_name'))]"},
                     "pip" : {"value":false},
                     "backend_address_pool_id" : {"value":"[variables('backend_address_pool_id')]"},
                     "tags" : {"value":
                                        {
                                            "sinequa-grid"                        : "[parameters('prefix')]",
                                            "sinequa-auto-disk"                   : "auto",
                                            "sinequa-path"                        : "F:\\sinequa",
                                            "sinequa-data-storage-url"            : "[variables('data_storage_url')]",
                                            "sinequa-primary-node-id"             : "[variables('node2_pn_id')]",
                                            "sinequa-node"                        : "[variables('node2_name')]",
                                            "sinequa-webapp"                      : "webapp2",
                                            "sinequa-engine"                      : "engine2"
                                        }}
                }                
            },
              "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'network')]",
                 "[resourceId('Microsoft.Resources/deployments', 'frontend')]",
                 "[resourceId('Microsoft.Resources/deployments', 'services')]"
            ]
        },  
        {
            "condition": "[equals(parameters('primaryNodeCount'),3)]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "primarynode3",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vm_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "vm_name" : {"value":"[variables('vm_node3_name')]"},
                     "vm_size" : {"value":"[parameters('vmSize')]"},
                     "computer_name" : {"value":"[variables('node3_name')]"},
                     "admin_username" : {"value":"[parameters('adminUsername')]"},
                     "admin_password" : {"value":"[parameters('adminPassword')]"},
                     "subnet_id" : {"value":"[variables('subnet_id1')]"},
                     "image_id": {"value":"[variables('imageReferenceId')]"},
                     "availability_set_id" : {"value":"[resourceId('Microsoft.Compute/availabilitySets', variables('availability_set_name'))]"},
                     "network_security_group_id" : {"value":"[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_app_name'))]"},
                     "pip" : {"value":false},
                     "backend_address_pool_id" : {"value":"[variables('backend_address_pool_id')]"},
                     "tags" : {"value":
                                        {
                                            "sinequa-grid"                        : "[parameters('prefix')]",
                                            "sinequa-auto-disk"                   : "auto",
                                            "sinequa-path"                        : "F:\\sinequa",
                                            "sinequa-data-storage-url"            : "[variables('data_storage_url')]",
                                            "sinequa-primary-node-id"             : "[variables('node3_pn_id')]",
                                            "sinequa-node"                        : "[variables('node3_name')]",
                                            "sinequa-webapp"                      : "webapp3"
                                        }}
                }                
            },
              "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'network')]",
                 "[resourceId('Microsoft.Resources/deployments', 'frontend')]",
                 "[resourceId('Microsoft.Resources/deployments', 'services')]"
            ]
        },              
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "indexer",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vmss_template_uri')]"
                },
                "parameters": {
                     "location": {"value":"[parameters('location')]"},
                     "vmss_name" : {"value":"[variables('vmss_indexer_name')]"},
                     "vmss_size" : {"value":"[parameters('vmIndexerSize')]"},
                     "vmss_capacity":{"value":"[parameters('vmIndexerScaleSetSize')]"},
                     "computer_name_prefix" : {"value":"indexer"},
                     "admin_username" : {"value":"[parameters('adminUsername')]"},
                     "admin_password" : {"value":"[parameters('adminPassword')]"},
                     "subnet_id" : {"value":"[variables('subnet_id1')]"},
                     "image_id": {"value":"[variables('imageReferenceId')]"},
                     "network_security_group_id" : {"value":"[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_app_name'))]"},
                     "tags" : {"value":
                                        {
                                            "sinequa-grid"                        : "[parameters('prefix')]",
                                            "sinequa-auto-disk"                   : "auto",
                                            "sinequa-path"                        : "F:\\sinequa",
                                            "sinequa-data-storage-url"            : "[variables('data_storage_url')]",
                                            "sinequa-node"                        : "[variables('indexer_name')]",
                                            "sinequa-indexer"                     : "indexer1"
                                        }}
                }                
            },
              "dependsOn": [
                 "[resourceId('Microsoft.Resources/deployments', 'network')]",
                 "[resourceId('Microsoft.Resources/deployments', 'frontend')]",
                 "[resourceId('Microsoft.Resources/deployments', 'services')]"
            ]
        }
    ],
    "outputs": {
        "osUsername": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        },
        "AdminUrl": {
            "type": "string",
            "value": "[concat('https://',reference('frontend').outputs.pip.value.IpAddress,'/admin')]"
        }
    }
}